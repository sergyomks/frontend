<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat en tiempo real</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f1f1f1;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #chats-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 860px; }
    .chat-container { background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; height: 80vh; }
    .messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .message {
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .own {
      background-color: #0084ff;
      color: white;
      align-self: flex-end;
    }
    .other {
      background-color: #e5e5ea;
      color: black;
      align-self: flex-start;
    }
    input {
      border: none;
      padding: 10px;
      outline: none;
      font-size: 16px;
      border-top: 1px solid #ccc;
    }
    .chat-header { padding: 10px 15px; border-bottom: 1px solid #eee; font-weight: bold; background: #fafafa; }
  </style>
</head>
<body>
  <div id="chats-wrapper">
    <div class="chat-container" id="chatA">
      <div class="chat-header">Usuario A</div>
      <div class="messages" id="messagesA"></div>
      <input type="text" id="messageInputA" placeholder="A: Escribe un mensaje y presiona Enter...">
    </div>
    <div class="chat-container" id="chatB">
      <div class="chat-header">Usuario B</div>
      <div class="messages" id="messagesB"></div>
      <input type="text" id="messageInputB" placeholder="B: Escribe un mensaje y presiona Enter...">
    </div>
  </div>

  <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
  <script>
    // ID único para distinguir quién envió el mensaje
    const senderId = Math.random().toString(36).substring(2, 15);
    const usernameA = localStorage.getItem('chat_username_a') || prompt('Nombre de Usuario A:') || 'UsuarioA';
    const usernameB = localStorage.getItem('chat_username_b') || prompt('Nombre de Usuario B:') || 'UsuarioB';
    localStorage.setItem('chat_username_a', usernameA);
    localStorage.setItem('chat_username_b', usernameB);

    // Unificar la key con la del backend
    const pusher = new Pusher('7dc9af9b21c755cdc52a', {
      cluster: 'us2'
    });

    const channel = pusher.subscribe('my-channel');
    const messagesA = document.getElementById('messagesA');
    const messagesB = document.getElementById('messagesB');
    const inputA = document.getElementById('messageInputA');
    const inputB = document.getElementById('messageInputB');

    // Recibir mensajes
    channel.bind('my-event', function(data) {
      // Renderizar en ambos paneles con perspectiva propia
      const typeA = data.username === usernameA ? 'own' : 'other';
      const typeB = data.username === usernameB ? 'own' : 'other';
      addMessage(messagesA, data, typeA);
      addMessage(messagesB, data, typeB);
    });

    // Enviar mensajes con Enter
    inputA.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && inputA.value.trim() !== '') {
        const text = inputA.value.trim();
        const localMessage = { username: usernameA, message: text, timestamp: new Date().toLocaleTimeString() };
        addMessage(messagesA, localMessage, 'own');
        addMessage(messagesB, localMessage, 'other');
        sendMessage(usernameA, text);
        inputA.value = '';
      }
    });
    inputB.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && inputB.value.trim() !== '') {
        const text = inputB.value.trim();
        const localMessage = { username: usernameB, message: text, timestamp: new Date().toLocaleTimeString() };
        addMessage(messagesB, localMessage, 'own');
        addMessage(messagesA, localMessage, 'other');
        sendMessage(usernameB, text);
        inputB.value = '';
      }
    });

    // Agregar mensaje al chat de un panel
    function addMessage(container, msg, type) {
      const wrapper = document.createElement('div');
      wrapper.classList.add('message', type);
      const header = document.createElement('div');
      header.style.fontSize = '12px';
      header.style.opacity = '0.7';
      header.textContent = `${msg.username} • ${msg.timestamp || ''}`;
      const body = document.createElement('div');
      body.textContent = msg.message;
      wrapper.appendChild(header);
      wrapper.appendChild(body);
      container.appendChild(wrapper);
      container.scrollTop = container.scrollHeight;
    }

    // Enviar mensaje al backend Flask
    function sendMessage(username, message) {
      fetch('/send_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, message })
      });
    }

    // Cargar historial inicial
    async function loadHistory() {
      try {
        const res = await fetch('/get_messages');
        const data = await res.json();
        (data.messages || []).forEach(m => {
          const typeA = m.username === usernameA ? 'own' : 'other';
          const typeB = m.username === usernameB ? 'own' : 'other';
          addMessage(messagesA, m, typeA);
          addMessage(messagesB, m, typeB);
        });
      } catch (e) {
        // Ignorar errores de historial
      }
    }
    loadHistory();
  </script>
</body>

</html>
